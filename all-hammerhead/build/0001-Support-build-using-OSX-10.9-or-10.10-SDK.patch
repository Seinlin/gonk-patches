From d31cf79aad81d2d323215f8a3cbf746e6b933160 Mon Sep 17 00:00:00 2001
From: John Lin <jolin@mozilla.com>
Date: Wed, 19 Nov 2014 10:52:44 +0800
Subject: [PATCH] Support build using OSX 10.9 or  10.10 SDK.

---
 core/combo/HOST_darwin-x86.mk    | 12 ++++++++++--
 core/combo/HOST_darwin-x86_64.mk | 12 ++++++++++--
 core/combo/mac_version.mk        |  2 +-
 3 files changed, 21 insertions(+), 5 deletions(-)

diff --git a/core/combo/HOST_darwin-x86.mk b/core/combo/HOST_darwin-x86.mk
index 4a2bfe3..4608827 100644
--- a/core/combo/HOST_darwin-x86.mk
+++ b/core/combo/HOST_darwin-x86.mk
@@ -37,7 +37,7 @@ $(combo_2nd_arch_prefix)HOST_TOOLCHAIN_PREFIX := $($(combo_2nd_arch_prefix)HOST_
 ifneq (,$(strip $(wildcard $($(combo_2nd_arch_prefix)HOST_TOOLCHAIN_PREFIX)-gcc)))
 $(combo_2nd_arch_prefix)HOST_CC  := $($(combo_2nd_arch_prefix)HOST_TOOLCHAIN_PREFIX)-gcc
 $(combo_2nd_arch_prefix)HOST_CXX := $($(combo_2nd_arch_prefix)HOST_TOOLCHAIN_PREFIX)-g++
-ifeq ($(mac_sdk_version),10.8)
+ifneq ($(filter 10.8 10.9 10.10, $(mac_sdk_version)),)
 # Mac SDK 10.8 no longer has stdarg.h, etc
 host_toolchain_header := $($(combo_2nd_arch_prefix)HOST_TOOLCHAIN_ROOT)/lib/gcc/i686-apple-darwin$(gcc_darwin_version)/4.2.1/include
 $(combo_2nd_arch_prefix)HOST_GLOBAL_CFLAGS += -isystem $(host_toolchain_header)
@@ -47,6 +47,14 @@ $(combo_2nd_arch_prefix)HOST_CC := gcc
 $(combo_2nd_arch_prefix)HOST_CXX := g++
 endif # $(HOST_TOOLCHAIN_PREFIX)-gcc exists
 
+ifneq ($(filter $(mac_sdk_version),10.9 10.10),)
+# 10.9+ SDK C++ header path
+$(combo_2nd_arch_prefix)HOST_GLOBAL_CFLAGS += -isystem $(mac_sdk_root)/usr/include/c++/4.2.1
+# Carbon API GetCurrentProcess() is deprecated
+$(combo_2nd_arch_prefix)HOST_GLOBAL_CFLAGS += -DCARBON_GET_CURRENT_PROCESS_DEPRECATED
+$(combo_2nd_arch_prefix)HOST_GLOBAL_LDFLAGS += -stdlib=libstdc++
+endif
+
 # gcc location for clang; to be updated when clang is updated
 # HOST_TOOLCHAIN_ROOT is a Darwin-specific define
 $(combo_2nd_arch_prefix)HOST_TOOLCHAIN_FOR_CLANG := $($(combo_2nd_arch_prefix)HOST_TOOLCHAIN_ROOT)
@@ -66,7 +74,7 @@ $(combo_2nd_arch_prefix)HOST_JNILIB_SUFFIX := .jnilib
 $(combo_2nd_arch_prefix)HOST_GLOBAL_CFLAGS += \
     -include $(call select-android-config-h,darwin-x86)
 
-ifneq ($(filter 10.7 10.7.% 10.8 10.8.%, $(build_mac_version)),)
+ifneq ($(filter 10.7 10.7.% 10.8 10.8.% 10.9 10.9.% 10.10 10.10.%, $(build_mac_version)),)
        $(combo_2nd_arch_prefix)HOST_RUN_RANLIB_AFTER_COPYING := false
 else
        $(combo_2nd_arch_prefix)HOST_RUN_RANLIB_AFTER_COPYING := true
diff --git a/core/combo/HOST_darwin-x86_64.mk b/core/combo/HOST_darwin-x86_64.mk
index 0bc0227..651b853 100644
--- a/core/combo/HOST_darwin-x86_64.mk
+++ b/core/combo/HOST_darwin-x86_64.mk
@@ -37,7 +37,7 @@ HOST_TOOLCHAIN_PREFIX := $(HOST_TOOLCHAIN_ROOT)/bin/i686-apple-darwin$(gcc_darwi
 ifneq (,$(strip $(wildcard $(HOST_TOOLCHAIN_PREFIX)-gcc)))
 HOST_CC  := $(HOST_TOOLCHAIN_PREFIX)-gcc
 HOST_CXX := $(HOST_TOOLCHAIN_PREFIX)-g++
-ifeq ($(mac_sdk_version),10.8)
+ifneq ($(filter 10.8 10.9 10.10, $(mac_sdk_version)),)
 # Mac SDK 10.8 no longer has stdarg.h, etc
 host_toolchain_header := $(HOST_TOOLCHAIN_ROOT)/lib/gcc/i686-apple-darwin$(gcc_darwin_version)/4.2.1/include
 HOST_GLOBAL_CFLAGS += -isystem $(host_toolchain_header)
@@ -47,6 +47,14 @@ HOST_CC := gcc
 HOST_CXX := g++
 endif # $(HOST_TOOLCHAIN_PREFIX)-gcc exists
 
+ifneq ($(filter $(mac_sdk_version),10.9 10.10),)
+# 10.9+ SDK C++ header path
+HOST_GLOBAL_CFLAGS += -isystem $(mac_sdk_root)/usr/include/c++/4.2.1
+# Carbon API GetCurrentProcess() is deprecated
+HOST_GLOBAL_CFLAGS += -DCARBON_GET_CURRENT_PROCESS_DEPRECATED
+HOST_GLOBAL_LDFLAGS += -stdlib=libstdc++
+endif
+
 # gcc location for clang; to be updated when clang is updated
 # HOST_TOOLCHAIN_ROOT is a Darwin-specific define
 HOST_TOOLCHAIN_FOR_CLANG := $(HOST_TOOLCHAIN_ROOT)
@@ -65,7 +73,7 @@ HOST_JNILIB_SUFFIX := .jnilib
 HOST_GLOBAL_CFLAGS += \
     -include $(call select-android-config-h,darwin-x86)
 
-ifneq ($(filter 10.7 10.7.% 10.8 10.8.%, $(build_mac_version)),)
+ifneq ($(filter 10.7 10.7.% 10.8 10.8.% 10.9 10.9.% 10.10 10.10.%, $(build_mac_version)),)
        HOST_RUN_RANLIB_AFTER_COPYING := false
 else
        HOST_RUN_RANLIB_AFTER_COPYING := true
diff --git a/core/combo/mac_version.mk b/core/combo/mac_version.mk
index b49feee..4332f3f 100644
--- a/core/combo/mac_version.mk
+++ b/core/combo/mac_version.mk
@@ -9,7 +9,7 @@ ifndef build_mac_version
 
 build_mac_version := $(shell sw_vers -productVersion)
 
-mac_sdk_versions_supported :=  10.6 10.7 10.8
+mac_sdk_versions_supported :=  10.6 10.7 10.8 10.9 10.10
 ifneq ($(strip $(MAC_SDK_VERSION)),)
 mac_sdk_version := $(MAC_SDK_VERSION)
 ifeq ($(filter $(mac_sdk_version),$(mac_sdk_versions_supported)),)
-- 
2.1.3


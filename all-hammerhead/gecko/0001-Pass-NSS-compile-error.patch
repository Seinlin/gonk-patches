From 30de7cd418520972189bc7b11669b61c372f666d Mon Sep 17 00:00:00 2001
From: Kai-Zhen Li <kli@mozilla.com>
Date: Tue, 28 Oct 2014 23:57:57 +0800
Subject: [PATCH] Pass NSS compile error.

---
 config/external/nss/Makefile.in      | 2 +-
 security/nss/coreconf/Linux.mk       | 2 +-
 security/nss/lib/Makefile            | 1 +
 security/nss/lib/softoken/fipstokn.c | 4 ++--
 4 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/config/external/nss/Makefile.in b/config/external/nss/Makefile.in
index 85f3e11..fb50c5f 100644
--- a/config/external/nss/Makefile.in
+++ b/config/external/nss/Makefile.in
@@ -217,7 +217,7 @@ DEFAULT_GMAKE_FLAGS += \
 	OS_PTHREAD= \
 	$(NULL)
 
-DEFAULT_GMAKE_FLAGS += ARCHFLAG='$(CFLAGS) -DCHECK_FORK_GETPID -DRTLD_NOLOAD=0 -include $(topsrcdir)/security/manager/android_stub.h'
+DEFAULT_GMAKE_FLAGS += ARCHFLAG='$(CFLAGS) -DCHECK_FORK_GETPID -include $(topsrcdir)/security/manager/android_stub.h'
 endif
 endif
 
diff --git a/security/nss/coreconf/Linux.mk b/security/nss/coreconf/Linux.mk
index 177a3c8..094fbb4 100644
--- a/security/nss/coreconf/Linux.mk
+++ b/security/nss/coreconf/Linux.mk
@@ -130,7 +130,7 @@ ifeq ($(USE_PTHREADS),1)
 OS_PTHREAD = -lpthread 
 endif
 
-OS_CFLAGS		= $(DSO_CFLAGS) $(OS_REL_CFLAGS) $(ARCHFLAG) -Wall -Werror-implicit-function-declaration -Wno-switch -pipe -ffunction-sections -fdata-sections -DLINUX -Dlinux -DHAVE_STRERROR
+OS_CFLAGS		= $(DSO_CFLAGS) $(OS_REL_CFLAGS) $(ARCHFLAG) -Wall -Wno-switch -pipe -ffunction-sections -fdata-sections -DLINUX -Dlinux -DHAVE_STRERROR
 OS_LIBS			= $(OS_PTHREAD) -ldl -lc
 
 ifdef USE_PTHREADS
diff --git a/security/nss/lib/Makefile b/security/nss/lib/Makefile
index a28bfd4..f5302e9 100644
--- a/security/nss/lib/Makefile
+++ b/security/nss/lib/Makefile
@@ -62,6 +62,7 @@ include $(CORE_DEPTH)/coreconf/rules.mk
 # (7) Execute "local" rules. (OPTIONAL).                              #
 #######################################################################
 
+$(error NSS_BUILD_WITHOUT_SOFTOKEN=$(NSS_BUILD_WITHOUT_SOFTOKEN))
 ifeq ($(NSS_BUILD_WITHOUT_SOFTOKEN),1)
 # Not included when building nss without softoken
 UTIL_SRCDIR =
diff --git a/security/nss/lib/softoken/fipstokn.c b/security/nss/lib/softoken/fipstokn.c
index 9435e71..e0f0fd3 100644
--- a/security/nss/lib/softoken/fipstokn.c
+++ b/security/nss/lib/softoken/fipstokn.c
@@ -372,7 +372,7 @@ sftk_LogAuditMessage(NSSAuditSeverity severity, NSSAuditType auditType,
     }
     /* timestamp is provided by syslog in the message header */
     syslog(level | LOG_USER /* facility */,
-	   "NSS " SOFTOKEN_LIB_NAME "[pid=%d uid=%d]: %s",
+	   "NSS libsoftokn3.so [pid=%d uid=%d]: %s",
 	   (int)getpid(), (int)getuid(), msg);
 #ifdef LINUX
     if (pthread_once(&libaudit_once_control, libaudit_init) != 0) {
@@ -382,7 +382,7 @@ sftk_LogAuditMessage(NSSAuditSeverity severity, NSSAuditType auditType,
 	int audit_fd;
 	int linuxAuditType;
 	int result = (severity != NSS_AUDIT_ERROR); /* 1=success; 0=failed */
-	char *message = PR_smprintf("NSS " SOFTOKEN_LIB_NAME ": %s", msg);
+	char *message = PR_smprintf("NSS libsoftokn3.so: %s", msg);
 	if (!message) {
 	    return;
 	}
-- 
1.9.1


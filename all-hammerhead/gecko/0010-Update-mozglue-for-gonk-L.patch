From e3e50222509f6705802963d10c9981c40ba13c33 Mon Sep 17 00:00:00 2001
From: Kai-Zhen Li <kli@mozilla.com>
Date: Sun, 16 Nov 2014 23:22:00 +0800
Subject: [PATCH 10/14] Update mozglue for gonk-L.

---
 mozglue/build/BionicGlue.cpp | 8 ++++++++
 mozglue/build/Nuwa.cpp       | 4 ++++
 2 files changed, 12 insertions(+)

diff --git a/mozglue/build/BionicGlue.cpp b/mozglue/build/BionicGlue.cpp
index ec4ec6a..18d1796 100644
--- a/mozglue/build/BionicGlue.cpp
+++ b/mozglue/build/BionicGlue.cpp
@@ -162,11 +162,19 @@ __wrap_PR_GetEnv(const char *var)
 }
 
 extern "C" NS_EXPORT int
+#if ANDROID_VERSION >= 21
+__wrap_PR_SetEnv(char *string)
+#else
 __wrap_PR_SetEnv(const char *string)
+#endif
 {
     int result;
 
+#if ANDROID_VERSION >= 21
+    if ( !strchr((const char*)string, '=')) return(-1);
+#else
     if ( !strchr(string, '=')) return(-1);
+#endif
 
     pthread_mutex_lock(&_pr_envLock);
     result = putenv(string);
diff --git a/mozglue/build/Nuwa.cpp b/mozglue/build/Nuwa.cpp
index 59a4e8a..b575e3e 100644
--- a/mozglue/build/Nuwa.cpp
+++ b/mozglue/build/Nuwa.cpp
@@ -59,10 +59,12 @@ int __real_pthread_cond_wait(pthread_cond_t *cond, pthread_mutex_t *mtx);
 int __real_pthread_cond_timedwait(pthread_cond_t *cond,
                                   pthread_mutex_t *mtx,
                                   const struct timespec *abstime);
+#if ANDROID_VERSION < 21
 int __real___pthread_cond_timedwait(pthread_cond_t *cond,
                                     pthread_mutex_t *mtx,
                                     const struct timespec *abstime,
                                     clockid_t clock);
+#endif
 int __real_pthread_mutex_lock(pthread_mutex_t *mtx);
 int __real_poll(struct pollfd *fds, nfds_t nfds, int timeout);
 int __real_epoll_create(int size);
@@ -1102,6 +1104,7 @@ __wrap_pthread_cond_timedwait(pthread_cond_t *cond,
   return rv;
 }
 
+#if ANDROID_VERSION < 21
 extern "C" int __pthread_cond_timedwait(pthread_cond_t *cond,
                                         pthread_mutex_t *mtx,
                                         const struct timespec *abstime,
@@ -1143,6 +1146,7 @@ __wrap___pthread_cond_timedwait(pthread_cond_t *cond,
 
   return rv;
 }
+#endif
 
 extern "C" MFBT_API int
 __wrap_pthread_mutex_lock(pthread_mutex_t *mtx) {
-- 
1.9.1

